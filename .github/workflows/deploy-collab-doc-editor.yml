# ============================================================
# Deploy — collab-doc-editor (Render backend + Netlify frontend)
# ============================================================
#
# Trigger rules:
#   - Push to main   → auto-deploy to TEST
#   - Push tag       → auto-deploy to PROD
#   - Manual trigger → choose environment
#
# Required GitHub secrets (per Environment: test / prod):
#   - COLLAB_EDITOR_RENDER_DEPLOY_HOOK_URL  → Render deploy hook for the backend service
#   - COLLAB_EDITOR_NETLIFY_SITE_ID         → Netlify site ID for the frontend
#   - NETLIFY_AUTH_TOKEN                     → Netlify personal access token (repo-level)
#
# Render service setup:
#   - Create a Web Service on render.com pointing to this repo
#   - Root directory: collab-doc-editor/backend
#   - Build command: (uses Dockerfile)
#   - Environment variables: HOST=0.0.0.0, JWT_SECRET=<your-secret>
#   - Copy the deploy hook URL into the GitHub Environment secret
#
# Netlify site setup:
#   - Create a new site on netlify.com (manual deploys)
#   - Copy the site ID into the GitHub Environment secret
#   - Generate a personal access token and store as repo secret
# ============================================================
name: "Deploy: collab-doc-editor"

on:
  push:
    branches: [main]
    paths:
      - "collab-doc-editor/**"
      - ".github/workflows/deploy-collab-doc-editor.yml"
    tags:
      - "collab-doc-editor-v*"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        type: choice
        options:
          - test
          - prod

concurrency:
  group: deploy-collab-doc-editor-${{ github.event.inputs.environment || (startsWith(github.ref, 'refs/tags/collab-doc-editor-v') && 'prod' || 'test') }}
  cancel-in-progress: false

jobs:
  # ── Determine target environment ───────────────────────────
  resolve-env:
    name: "Resolve Environment"
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/collab-doc-editor-v* ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=test" >> $GITHUB_OUTPUT
          fi

  # ── Run CI checks before deploying ─────────────────────────
  ci:
    name: "CI Checks"
    uses: ./.github/workflows/ci-collab-doc-editor.yml

  # ── Deploy Backend to Render ───────────────────────────────
  deploy-backend:
    name: "Deploy Backend (Render) — ${{ needs.resolve-env.outputs.environment }}"
    runs-on: ubuntu-latest
    needs: [resolve-env, ci]
    environment: ${{ needs.resolve-env.outputs.environment }}
    env:
      ENV: ${{ needs.resolve-env.outputs.environment }}
    steps:
      - name: Trigger Render deploy
        run: |
          echo "Triggering Render deploy for collab-doc-editor backend (${{ env.ENV }})..."
          RESPONSE=$(curl -sf "${{ secrets.COLLAB_EDITOR_RENDER_DEPLOY_HOOK_URL }}")
          echo "Render deploy triggered successfully."

  # ── Deploy Frontend to Netlify ─────────────────────────────
  deploy-frontend:
    name: "Deploy Frontend (Netlify) — ${{ needs.resolve-env.outputs.environment }}"
    runs-on: ubuntu-latest
    needs: [resolve-env, ci]
    environment: ${{ needs.resolve-env.outputs.environment }}
    env:
      ENV: ${{ needs.resolve-env.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: collab-doc-editor/frontend/package-lock.json

      - name: Install dependencies
        working-directory: collab-doc-editor/frontend
        run: npm ci

      - name: Build frontend
        working-directory: collab-doc-editor/frontend
        run: npm run build
        env:
          VITE_API_URL: ${{ vars.COLLAB_EDITOR_API_URL }}

      - name: Install Netlify CLI
        run: npm install -g netlify-cli

      - name: Deploy to Netlify
        working-directory: collab-doc-editor/frontend
        run: |
          if [ "${{ env.ENV }}" = "prod" ]; then
            netlify deploy --dir=dist --prod --message "Deploy ${{ github.sha }}"
          else
            netlify deploy --dir=dist --message "Preview deploy ${{ github.sha }}"
          fi
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.COLLAB_EDITOR_NETLIFY_SITE_ID }}
