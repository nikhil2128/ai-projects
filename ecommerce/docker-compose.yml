version: "3.8"

x-backend-common: &backend-common
  build:
    context: ./backend
    dockerfile: Dockerfile.service
  restart: unless-stopped
  networks:
    - app-network
  healthcheck:
    test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${PORT:-3000}/health"]
    interval: 15s
    timeout: 5s
    retries: 3
    start_period: 10s
  deploy:
    resources:
      limits:
        memory: 256M
        cpus: "0.5"
      reservations:
        memory: 128M
        cpus: "0.25"

services:
  # ── Reverse Proxy ──────────────────────────────────────────────────
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      gateway:
        condition: service_healthy
      frontend:
        condition: service_started
    restart: unless-stopped
    networks:
      - app-network
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.25"

  # ── Redis Cache ────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru --appendonly no
    ports:
      - "6379:6379"
    restart: unless-stopped
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 300M
          cpus: "0.25"

  # ── API Gateway ────────────────────────────────────────────────────
  gateway:
    <<: *backend-common
    build:
      context: ./backend
      dockerfile: Dockerfile.service
      args:
        SERVICE_PATH: gateway/index.js
    environment:
      PORT: 3000
      AUTH_SERVICE_URL: http://auth:3001
      PRODUCT_SERVICE_URL: http://product:3002
      CART_SERVICE_URL: http://cart:3003
      ORDER_SERVICE_URL: http://order:3004
      PAYMENT_SERVICE_URL: http://payment:3005
      CORS_ORIGIN: "*"
    ports:
      - "3000:3000"
    depends_on:
      auth:
        condition: service_healthy
      product:
        condition: service_healthy
      cart:
        condition: service_healthy
      order:
        condition: service_healthy
      payment:
        condition: service_healthy

  # ── Auth Service ───────────────────────────────────────────────────
  auth:
    <<: *backend-common
    build:
      context: ./backend
      dockerfile: Dockerfile.service
      args:
        SERVICE_PATH: services/auth/src/index.js
    environment:
      PORT: 3001
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]

  # ── Product Service ────────────────────────────────────────────────
  product:
    <<: *backend-common
    build:
      context: ./backend
      dockerfile: Dockerfile.service
      args:
        SERVICE_PATH: services/product/src/index.js
    environment:
      PORT: 3002
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]

  # ── Cart Service ───────────────────────────────────────────────────
  cart:
    <<: *backend-common
    build:
      context: ./backend
      dockerfile: Dockerfile.service
      args:
        SERVICE_PATH: services/cart/src/index.js
    environment:
      PORT: 3003
      PRODUCT_SERVICE_URL: http://product:3002
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3003/health"]

  # ── Order Service ──────────────────────────────────────────────────
  order:
    <<: *backend-common
    build:
      context: ./backend
      dockerfile: Dockerfile.service
      args:
        SERVICE_PATH: services/order/src/index.js
    environment:
      PORT: 3004
      CART_SERVICE_URL: http://cart:3003
      PRODUCT_SERVICE_URL: http://product:3002
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3004/health"]

  # ── Payment Service ────────────────────────────────────────────────
  payment:
    <<: *backend-common
    build:
      context: ./backend
      dockerfile: Dockerfile.service
      args:
        SERVICE_PATH: services/payment/src/index.js
    environment:
      PORT: 3005
      ORDER_SERVICE_URL: http://order:3004
      PRODUCT_SERVICE_URL: http://product:3002
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3005/health"]

  # ── Frontend ───────────────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    networks:
      - app-network
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: "0.1"

networks:
  app-network:
    driver: bridge
